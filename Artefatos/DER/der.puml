@startuml
title DER - Gabinete Inteligente (com Perfis e Permissões)

skinparam shadowing false
skinparam class {
  BackgroundColor #ffffff
  BorderColor #2c3e50
}

' ===================== AUTORIZAÇÃO =====================

entity PerfilAcesso {
  * id : INT <<PK>>
  --
  nome : VARCHAR   'ex.: DEPUTADA, CHEFE, GESTORA'
  descricao : VARCHAR
}

entity Permissao {
  * id : INT <<PK>>
  --
  codigo : VARCHAR   'ex.: RELATORIO_DEMANDAS'
  descricao : VARCHAR
}

entity PerfilPermissao {
  * perfil_id : INT <<FK>>
  * permissao_id : INT <<FK>>
}

entity Usuario {
  * id : INT <<PK>>
  --
  nome : VARCHAR
  email : VARCHAR
  senha_hash : VARCHAR
  perfil_id : INT <<FK>>
  criado_em : DATETIME
  atualizado_em : DATETIME
}


' ===================== DOMÍNIO DO SISTEMA =====================

entity Demanda {
  * id : INT <<PK>>
  --
  titulo : VARCHAR
  descricao : TEXT
  status : ENUM("ABERTA","EM_ANDAMENTO","CONCLUIDA")
  prioridade : ENUM("BAIXA","MEDIA","ALTA")
  responsavel_id : INT <<FK>>
  cidade_id : INT <<FK>>
  instituicao_id : INT <<FK>>
  criado_por_id : INT <<FK>>
  criado_em : DATETIME
  atualizado_em : DATETIME
}

entity Emenda {
  * id : INT <<PK>>
  --
  numero : VARCHAR
  valor : DECIMAL(14,2)
  status : ENUM("PLANEJADA","EM_EXECUCAO","CONCLUIDA")
  cidade_id : INT <<FK>>
  area_aplicacao : VARCHAR
  criado_em : DATETIME
  atualizado_em : DATETIME
}

entity Cidade {
  * id : INT <<PK>>
  --
  nome : VARCHAR
  regiao : VARCHAR
}

entity Instituicao {
  * id : INT <<PK>>
  --
  nome : VARCHAR
  tipo : VARCHAR
  cidade_id : INT <<FK>>
}

entity Lideranca {
  * id : INT <<PK>>
  --
  nome : VARCHAR
  cargo : VARCHAR
  instituicao_id : INT <<FK>>
}

entity Evento {
  * id : INT <<PK>>
  --
  titulo : VARCHAR
  data_hora : DATETIME
  local : VARCHAR
  contexto : TEXT
  criado_em : DATETIME
  atualizado_em : DATETIME
}

entity DemandaEvento {
  * demanda_id : INT <<FK>>
  * evento_id : INT <<FK>>
}

entity Anexo {
  * id : INT <<PK>>
  --
  tabela_ref : VARCHAR     'ex.: demanda, emenda'
  id_ref : INT
  caminho_arquivo : VARCHAR
  criado_em : DATETIME
}


' ===================== RELACIONAMENTOS =====================

' --- AUTORIZAÇÃO ---
Usuario "1" -- "1" PerfilAcesso : pertence >
PerfilAcesso "1" -- "0..*" Usuario

PerfilAcesso "1" -- "0..*" PerfilPermissao : >
Permissao "1" -- "0..*" PerfilPermissao : <>

' --- USUÁRIO E DEMANDAS ---
Usuario "1" -- "0..*" Demanda : cria >\n(criado_por_id)
Usuario "1" -- "0..*" Demanda : responsável >\n(responsavel_id)

' --- CIDADE ---
Cidade "1" -- "0..*" Demanda
Cidade "1" -- "0..*" Emenda
Cidade "1" -- "0..*" Instituicao

' --- INSTITUIÇÃO E LIDERANÇA ---
Instituicao "1" -- "0..*" Lideranca
Instituicao "1" -- "0..*" Demanda

' --- EVENTOS E DEMANDAS (N-N) ---
Demanda "0..*" -- "0..*" Evento : DemandaEvento

' --- ANEXOS POLIMÓRFICOS ---
Demanda "1" -- "0..*" Anexo : anexos
Emenda  "1" -- "0..*" Anexo : anexos

@enduml
